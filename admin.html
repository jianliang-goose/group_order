<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† - å»ºè‰¯éµè‚‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* Table Styles */
        .data-table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }

        .items-cell {
            font-size: 0.9rem;
            color: #444;
            max-width: 300px;
        }

        .status-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .note-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            margin-right: 5px;
            font-size: 0.85rem;
        }

        .btn-save {
            background-color: #28a745;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .nav-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <header style="background: white; border-bottom: 1px solid #ddd; padding: 15px 0;">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:20px;">
                <h1 style="font-size: 1.5rem; margin:0;">è¨‚å–®ç®¡ç†å¾Œå°</h1>
                <nav>
                    <a href="admin.html" class="nav-link" style="color: #333; font-weight:bold;">è¨‚å–®åˆ—è¡¨</a>
                    <span style="color:#ccc">|</span>
                    <a href="settings.html" class="nav-link">âš™ï¸ å•†åº—è¨­å®š</a>
                </nav>
            </div>
            <a href="index.html" style="color: #666; text-decoration: none;">å›å‰å°</a>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Statistics -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">æœªè™•ç†è¨‚å–®</div>
            </div>
        </section>

        <!-- Orders Table -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 class="section-title" style="margin:0;">è¨‚å–®åˆ—è¡¨</h2>
            <button onclick="location.reload()" style="padding: 8px 15px; cursor:pointer;">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>

        <div class="data-table-wrapper">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th>è¨‚å–®ç·¨è™Ÿ / æ™‚é–“</th>
                        <th>å§“å / é›»è©±</th>
                        <th>åœ˜è³¼ä¸»</th>
                        <th>å–è²¨æ–¹å¼</th>
                        <th>è¨‚è³¼å…§å®¹</th>
                        <th>ç¸½é‡‘é¡</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" style="text-align:center; padding: 30px;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof GAS_API_URL === 'undefined' || GAS_API_URL.includes("YOUR_GAS_WEB_APP_URL")) {
                alert("è«‹å…ˆè¨­å®š GAS URL (è«‹æª¢æŸ¥ script.js)");
                return;
            }
            fetchOrders();
        });

        async function fetchOrders() {
            try {
                const response = await fetch(`${GAS_API_URL}?type=orders`);
                const orders = await response.json();
                renderDashboard(orders);
            } catch (e) {
                console.error(e);
                alert("ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™");
            }
        }

        function renderProductStats(stats) {
            // Find or Create Container
            let container = document.getElementById('productStatsContainer');
            if (!container) {
                const statsGrid = document.querySelector('.stats-grid');
                // Insert after main stats grid
                const section = document.createElement('div');
                section.id = 'productStatsContainer';
                section.className = 'data-table-wrapper';
                section.style.marginBottom = '30px';
                section.style.padding = '20px';

                const title = document.createElement('h3');
                title.innerText = 'ğŸ“Š å•†å“éŠ·å”®çµ±è¨ˆ';
                title.style.margin = '0 0 15px 0';
                title.style.color = '#333';

                const content = document.createElement('div');
                content.id = 'productStatsContent';
                content.style.display = 'grid';
                content.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                content.style.gap = '15px';

                section.appendChild(title);
                section.appendChild(content);

                // Insert into DOM
                statsGrid.parentNode.insertBefore(section, statsGrid.nextSibling);
                container = section;
            }

            const contentDiv = document.getElementById('productStatsContent');
            contentDiv.innerHTML = ''; // Clear old

            // Sort by Qty desc
            const sortedItems = Object.entries(stats).sort((a, b) => b[1] - a[1]);

            if (sortedItems.length === 0) {
                contentDiv.innerHTML = '<div style="color:#777;">å°šç„¡éŠ·å”®æ•¸æ“š</div>';
                return;
            }

            sortedItems.forEach(([name, qty]) => {
                const card = document.createElement('div');
                card.style.background = '#f9f9f9';
                card.style.padding = '10px';
                card.style.borderRadius = '5px';
                card.style.borderLeft = '4px solid var(--primary-color)';
                card.innerHTML = `
                    <div style="font-size:0.9rem; color:#555; margin-bottom:5px;">${name}</div>
                    <div style="font-size:1.5rem; font-weight:bold; color:#333;">${qty}</div>
                `;
                contentDiv.appendChild(card);
            });
        }

        // Stats
        try {
            document.getElementById('totalOrders').innerText = orders.length;

            // Robust parsing for Total Amount (remove commas, handle currency symbols)
            const revenue = orders.reduce((sum, o) => {
                let valStr = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                return sum + (parseFloat(valStr) || 0);
            }, 0);
            document.getElementById('totalRevenue').innerText = `$${Math.round(revenue).toLocaleString()}`;

            const pending = orders.filter(o => o.Status === 'æœªè™•ç†').length;
            document.getElementById('pendingOrders').innerText = pending;

            // Table
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            // Sort new to old (Robust Date Parsing)
            orders.sort((a, b) => {
                const dateA = new Date(a.Timestamp);
                const dateB = new Date(b.Timestamp);
                // If invalid date (e.g. Chinese format issue), treat as 0 or current
                const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
                const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime();
                return timeB - timeA;
            });

            orders.forEach(o => {
                const tr = document.createElement('tr');

                // Display Date Safely
                let dateDisplay = o.Timestamp;
                const dateObj = new Date(o.Timestamp);
                if (!isNaN(dateObj.getTime())) {
                    dateDisplay = dateObj.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                }

                // Status Dropdown
                const statusOptions = ['æœªè™•ç†', 'å·²ç¢ºèª', 'å·²å‡ºè²¨/å¾…å–', 'å·²å®Œæˆ', 'å·²å–æ¶ˆ'];
                let statusHtml = `<select class="status-select" id="status-${o.Order_ID}">`;
                statusOptions.forEach(st => {
                    const selected = (o.Status === st) ? 'selected' : '';
                    statusHtml += `<option value="${st}" ${selected}>${st}</option>`;
                });
                statusHtml += `</select>`;

                // Price Display Safely
                let priceVal = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                let priceNum = parseFloat(priceVal) || 0;

                tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${o.Order_ID}</div>
                            <div style="font-size:0.85rem; color:#666;">${dateDisplay}</div>
                        </td>
                        <td>
                            <div>${o.Name}</div>
                            <div style="font-size:0.85rem; color:#666;">${o.Phone}</div>
                        </td>
                        <td>${o.Group_Leader || '-'}</td>
                        <td>
                            ${o.Delivery_Method}<br>
                            <span style="font-size:0.8rem; color:#888;">${o.Store_Info || ''}</span>
                        </td>
                        <td class="items-cell">${o.Items}</td>
                        <td style="font-weight:bold; color:var(--primary-color);">$${priceNum.toLocaleString()}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <input type="text" class="note-input" id="note-${o.Order_ID}" value="${o.Note || ''}" placeholder="å‚™è¨»...">
                        </td>
                        <td>
                            <button class="action-btn btn-save" onclick="updateOrder('${o.Order_ID}')">å„²å­˜</button>
                        </td>
                    `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("Render Error:", err);
            alert("æ¸²æŸ“è¨‚å–®åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: " + err.message);
        }

        async function updateOrder(orderId) {
            const status = document.getElementById(`status-${orderId}`).value;
            const note = document.getElementById(`note-${orderId}`).value;

            const btn = document.querySelector(`button[onclick="updateOrder('${orderId}')"]`);
            const originalText = btn.innerText;
            btn.innerText = '...';
            btn.disabled = true;

            try {
                const payload = {
                    action: 'updateOrder',
                    orderId: orderId,
                    status: status,
                    note: note
                };

                await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                // Since no-cors returns opaque, we assume success if no network error
                alert('æ›´æ–°æˆåŠŸï¼');
            } catch (e) {
                console.error(e);
                alert('æ›´æ–°å¤±æ•—');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>