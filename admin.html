<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† - å»ºè‰¯éµè‚‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* Table Styles */
        .data-table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }

        .items-cell {
            font-size: 0.9rem;
            color: #444;
            max-width: 300px;
        }

        .status-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .note-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            margin-right: 5px;
            font-size: 0.85rem;
        }

        .btn-save {
            background-color: #28a745;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .nav-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <header style="background: white; border-bottom: 1px solid #ddd; padding: 15px 0;">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:20px;">
                <h1 style="font-size: 1.5rem; margin:0;">è¨‚å–®ç®¡ç†å¾Œå°</h1>
                <nav>
                    <a href="admin.html" class="nav-link" style="color: #333; font-weight:bold;">è¨‚å–®åˆ—è¡¨</a>
                    <span style="color:#ccc">|</span>
                    <a href="settings.html" class="nav-link">âš™ï¸ å•†åº—è¨­å®š</a>
                </nav>
            </div>
            <a href="index.html" style="color: #666; text-decoration: none;">å›å‰å°</a>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Statistics -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">æœªè™•ç†è¨‚å–®</div>
            </div>
        </section>

        <!-- Orders Table -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 class="section-title" style="margin:0;">è¨‚å–®åˆ—è¡¨</h2>
            <button onclick="location.reload()" style="padding: 8px 15px; cursor:pointer;">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>

        <div class="data-table-wrapper">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th>è¨‚å–®ç·¨è™Ÿ / æ™‚é–“</th>
                        <th>å§“å / é›»è©±</th>
                        <th>åœ˜è³¼ä¸»</th>
                        <th>å–è²¨æ–¹å¼</th>
                        <th>è¨‚è³¼å…§å®¹</th>
                        <th>ç¸½é‡‘é¡</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" style="text-align:center; padding: 30px;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof GAS_API_URL === 'undefined' || GAS_API_URL.includes("YOUR_GAS_WEB_APP_URL")) {
                alert("è«‹å…ˆè¨­å®š GAS URL (è«‹æª¢æŸ¥ script.js)");
                return;
            }
            fetchOrders();
        });

        async function fetchOrders() {
            try {
                const response = await fetch(`${GAS_API_URL}?type=orders`);
                const orders = await response.json();
                console.log("Orders Data:", orders);
                renderDashboard(orders);
            } catch (e) {
                console.error("Fetch/Render Error:", e);
                alert("ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™: " + e.message);
            }
        }

        function calculateAndRenderStats(orders) {
            // Find or Create Container
            let container = document.getElementById('productStatsContainer');
            if (!container) {
                const statsGrid = document.querySelector('.stats-grid');
                const section = document.createElement('div');
                section.id = 'productStatsContainer';
                section.className = 'data-table-wrapper';
                section.style.marginBottom = '30px';
                section.style.padding = '25px';
                section.style.background = '#fff';
                section.style.borderRadius = '10px';
                section.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';

                // Header with Title and Filter
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.style.marginBottom = '20px';
                headerDiv.style.borderBottom = '1px solid #eee';
                headerDiv.style.paddingBottom = '15px';

                const title = document.createElement('h3');
                title.innerText = 'ğŸ“Š å•†å“éŠ·å”®çµ±è¨ˆ';
                title.style.margin = '0';
                title.style.color = '#333';
                title.style.fontSize = '1.3rem';

                // Status Filter Dropdown
                const filterWrapper = document.createElement('div');
                filterWrapper.style.marginLeft = 'auto';
                filterWrapper.style.display = 'flex';
                filterWrapper.style.alignItems = 'center';
                filterWrapper.style.gap = '10px';

                const filterLabel = document.createElement('span');
                filterLabel.innerText = 'ç‹€æ…‹ç¯©é¸:';
                filterLabel.style.fontSize = '0.9rem';
                filterLabel.style.color = '#666';

                const filterSelect = document.createElement('select');
                filterSelect.id = 'statsStatusFilter';
                filterSelect.className = 'status-select'; // Reuse existing style class or custom
                filterSelect.style.padding = '6px 12px';
                filterSelect.style.borderRadius = '6px';
                filterSelect.style.border = '1px solid #ddd';
                filterSelect.style.fontSize = '0.9rem';
                filterSelect.style.cursor = 'pointer';
                filterSelect.style.outline = 'none';

                filterSelect.innerHTML = `
                    <option value="ALL">ğŸ“‹ å…¨éƒ¨ (å·²å–æ¶ˆé™¤å¤–)</option>
                    <option value="æœªè™•ç†">ğŸ”´ æœªè™•ç†</option>
                    <option value="å·²ç¢ºèª">ğŸ”µ å·²ç¢ºèª</option>
                    <option value="å·²å‡ºè²¨/å¾…å–">ğŸŸ¢ å·²å‡ºè²¨/å¾…å–</option>
                    <option value="å·²å®Œæˆ">ğŸ å·²å®Œæˆ</option>
                `;

                filterSelect.addEventListener('change', () => {
                    if (window.currentOrdersData) {
                        calculateAndRenderStats(window.currentOrdersData);
                    }
                });

                filterWrapper.appendChild(filterLabel);
                filterWrapper.appendChild(filterSelect);
                headerDiv.appendChild(title);
                headerDiv.appendChild(filterWrapper);

                const content = document.createElement('div');
                content.id = 'productStatsContent';
                content.style.display = 'grid';
                content.style.gridTemplateColumns = 'repeat(auto-fill, minmax(220px, 1fr))';
                content.style.gap = '20px';

                section.appendChild(headerDiv);
                section.appendChild(content);
                statsGrid.parentNode.insertBefore(section, statsGrid.nextSibling);
                container = section;
            }

            // Calculation Logic
            const filterValue = document.getElementById('statsStatusFilter') ? document.getElementById('statsStatusFilter').value : 'ALL';
            const productStats = {};
            let matchCount = 0;

            orders.forEach(o => {
                if (o.Status === 'å·²å–æ¶ˆ') return;
                if (filterValue !== 'ALL' && o.Status !== filterValue) return;

                matchCount++;
                const itemsStr = o.Items || "";
                const itemParts = itemsStr.split(/,\s*/);
                itemParts.forEach(part => {
                    const match = part.match(/(.+)x(\d+)$/);
                    if (match) {
                        const name = match[1].trim();
                        const qty = parseInt(match[2]);
                        if (productStats[name]) {
                            productStats[name] += qty;
                        } else {
                            productStats[name] = qty;
                        }
                    }
                });
            });

            // Render Results
            const contentDiv = document.getElementById('productStatsContent');
            contentDiv.innerHTML = '';

            const sortedItems = Object.entries(productStats).sort((a, b) => b[1] - a[1]);

            if (matchCount === 0 || sortedItems.length === 0) {
                contentDiv.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:30px; color:#999; background:#f9f9f9; border-radius:8px;">
                        ç„¡ç¬¦åˆæ¢ä»¶çš„éŠ·å”®æ•¸æ“š
                    </div>`;
                return;
            }

            sortedItems.forEach(([name, qty]) => {
                const card = document.createElement('div');
                card.style.background = '#fff';
                card.style.padding = '15px';
                card.style.borderRadius = '8px';
                card.style.border = '1px solid #eee';
                card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.03)';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.position = 'relative';
                card.style.overflow = 'hidden';

                // Left accent bar
                const bar = document.createElement('div');
                bar.style.position = 'absolute';
                bar.style.left = '0';
                bar.style.top = '0';
                bar.style.bottom = '0';
                bar.style.width = '5px';
                bar.style.background = 'var(--primary-color)';
                card.appendChild(bar);

                card.innerHTML += `
                    <div style="font-size:0.95rem; color:#666; margin-bottom:8px; padding-left:10px; line-height:1.4;">${name}</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#333; padding-left:10px;">${qty} <span style="font-size:0.9rem; font-weight:normal; color:#999;">ä»½</span></div>
                `;
                contentDiv.appendChild(card);
            });
        }

        function renderDashboard(orders) {
            // Save globally for filtering logic
            window.currentOrdersData = orders;

            // Stats
            try {
                // 1. Basic Counts
                document.getElementById('totalOrders').innerText = orders.length;

                // 2. Revenue Parsing
                const revenue = orders.reduce((sum, o) => {
                    if (o.Status === 'å·²å–æ¶ˆ') return sum;
                    let valStr = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                    return sum + (parseFloat(valStr) || 0);
                }, 0);
                document.getElementById('totalRevenue').innerText = `$${Math.round(revenue).toLocaleString()}`;

                // 3. Product Sales Statistics (Enhanced)
                calculateAndRenderStats(orders);

                const pending = orders.filter(o => o.Status === 'æœªè™•ç†').length;
                document.getElementById('pendingOrders').innerText = pending;

                // Table
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';

                // Sort new to old (Robust Date Parsing)
                orders.sort((a, b) => {
                    const dateA = new Date(a.Timestamp);
                    const dateB = new Date(b.Timestamp);
                    // If invalid date (e.g. Chinese format issue), treat as 0 or current
                    const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
                    const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime();
                    return timeB - timeA;
                });

                orders.forEach(o => {
                    const tr = document.createElement('tr');

                    // Display Date Safely
                    let dateDisplay = o.Timestamp;
                    const dateObj = new Date(o.Timestamp);
                    if (!isNaN(dateObj.getTime())) {
                        dateDisplay = dateObj.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                    }

                    // Status Dropdown
                    const statusOptions = ['æœªè™•ç†', 'å®Œæˆå¾…å–', 'å·²å‡ºè²¨', 'å·²å–æ¶ˆ'];
                    let statusHtml = `<select class="status-select" id="status-${o.Order_ID}">`;
                    statusOptions.forEach(st => {
                        const selected = (o.Status === st) ? 'selected' : '';
                        statusHtml += `<option value="${st}" ${selected}>${st}</option>`;
                    });
                    statusHtml += `</select>`;

                    // Price Display Safely
                    let priceVal = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                    let priceNum = parseFloat(priceVal) || 0;

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${o.Order_ID}</div>
                            <div style="font-size:0.85rem; color:#666;">${dateDisplay}</div>
                        </td>
                        <td>
                            <div>${o.Name}</div>
                            <div style="font-size:0.85rem; color:#666;">${o.Phone}</div>
                        </td>
                        <td>${o.Group_Leader || '-'}</td>
                        <td>
                            ${o.Delivery_Method}<br>
                            <span style="font-size:0.8rem; color:#888;">${o.Store_Info || ''}</span>
                        </td>
                        <td class="items-cell">${o.Items}</td>
                        <td style="font-weight:bold; color:var(--primary-color);">$${priceNum.toLocaleString()}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <input type="text" class="note-input" id="note-${o.Order_ID}" value="${o.Note || ''}" placeholder="å‚™è¨»...">
                        </td>
                        <td>
                            <button class="action-btn btn-save" onclick="updateOrder('${o.Order_ID}')">å„²å­˜</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("Render Error:", err);
                alert("æ¸²æŸ“è¨‚å–®åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: " + err.message);
            }
        }

        async function updateOrder(orderId) {
            const status = document.getElementById(`status-${orderId}`).value;
            const note = document.getElementById(`note-${orderId}`).value;

            const btn = document.querySelector(`button[onclick="updateOrder('${orderId}')"]`);
            const originalText = btn.innerText;
            btn.innerText = '...';
            btn.disabled = true;

            try {
                const payload = {
                    action: 'updateOrder',
                    orderId: orderId,
                    status: status,
                    note: note
                };

                await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                // Since no-cors returns opaque, we assume success if no network error
                alert('æ›´æ–°æˆåŠŸï¼');
            } catch (e) {
                console.error(e);
                alert('æ›´æ–°å¤±æ•—');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>