<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† - å»ºè‰¯éµè‚‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* Table Styles */
        .data-table-wrapper {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background-color: #f9f9f9;
        }

        .items-cell {
            font-size: 0.9rem;
            color: #444;
            max-width: 300px;
        }

        .status-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .note-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            margin-right: 5px;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .btn-save {
            background-color: #28a745;
        }

        .btn-save:hover {
            background-color: #218838;
        }

        .btn-edit {
            background-color: #007bff;
        }

        .btn-edit:hover {
            background-color: #0056b3;
        }

        .btn-verify {
            background-color: #ffc107;
            color: #333;
        }

        .btn-verify:hover {
            background-color: #e0a800;
        }

        .btn-verify.verified {
            background-color: #28a745;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        /* Payment Info Styles */
        .payment-info {
            font-size: 0.8rem;
            color: #666;
            max-width: 150px;
        }

        .payment-method {
            font-weight: 600;
            color: #333;
        }

        /* Edit Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-form .form-group {
            margin-bottom: 15px;
        }

        .modal-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .modal-form input,
        .modal-form select,
        .modal-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .modal-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        .modal-actions .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Verified Badge */
        .verified-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .verified-badge.yes {
            background: #d4edda;
            color: #155724;
        }

        .verified-badge.no {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>

<body>
    <header style="background: white; border-bottom: 1px solid #ddd; padding: 15px 0;">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:20px;">
                <h1 style="font-size: 1.5rem; margin:0;">è¨‚å–®ç®¡ç†å¾Œå°</h1>
                <nav>
                    <a href="admin.html" class="nav-link" style="color: #333; font-weight:bold;">è¨‚å–®åˆ—è¡¨</a>
                    <span style="color:#ccc">|</span>
                    <a href="settings.html" class="nav-link">âš™ï¸ å•†åº—è¨­å®š</a>
                </nav>
            </div>
            <a href="index.html" style="color: #666; text-decoration: none;">å›å‰å°</a>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Statistics -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">$0</div>
                <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">æœªè™•ç†è¨‚å–®</div>
            </div>
        </section>

        <!-- Orders Table -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h2 class="section-title" style="margin:0;">è¨‚å–®åˆ—è¡¨</h2>
            <button onclick="location.reload()" style="padding: 8px 15px; cursor:pointer;">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>

        <div class="data-table-wrapper">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th>è¨‚å–®ç·¨è™Ÿ / æ™‚é–“</th>
                        <th>å§“å / é›»è©±</th>
                        <th>åœ˜è³¼ä¸»</th>
                        <th>å–è²¨æ–¹å¼</th>
                        <th>è¨‚è³¼å…§å®¹</th>
                        <th>é‡‘é¡</th>
                        <th>ä»˜æ¬¾</th>
                        <th>å°å¸³è³‡è¨Š</th>
                        <th>ç‹€æ…‹</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="11" style="text-align:center; padding: 30px;">è¼‰å…¥ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Edit Order Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœï¸ ç·¨è¼¯è¨‚å–®</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form class="modal-form" onsubmit="saveOrderEdit(event)">
                <input type="hidden" id="edit-orderId">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label>é›»è©±</label>
                        <input type="text" id="edit-phone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>åœ˜è³¼ä¸»</label>
                    <input type="text" id="edit-groupLeader">
                </div>

                <div class="form-group">
                    <label>è¨‚è³¼å…§å®¹</label>
                    <textarea id="edit-items"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>å•†å“é‡‘é¡</label>
                        <input type="number" id="edit-totalAmount">
                    </div>
                    <div class="form-group">
                        <label>é‹è²»</label>
                        <input type="number" id="edit-shippingFee">
                    </div>
                    <div class="form-group">
                        <label>æ‡‰ä»˜ç¸½é¡</label>
                        <input type="number" id="edit-grandTotal">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>å–è²¨æ–¹å¼</label>
                        <select id="edit-deliveryMethod">
                            <option value="ç¾å ´è‡ªå–">ç¾å ´è‡ªå–</option>
                            <option value="å†·å‡åº—åˆ°åº—">å†·å‡åº—åˆ°åº—</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è¶…å•†/é–€å¸‚è³‡è¨Š</label>
                        <input type="text" id="edit-storeInfo">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>ä»˜æ¬¾æ–¹å¼</label>
                        <select id="edit-paymentMethod">
                            <option value="ATMè½‰å¸³">ATMè½‰å¸³</option>
                            <option value="è¡—å£æ”¯ä»˜">è¡—å£æ”¯ä»˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å°å¸³è³‡è¨Š</label>
                        <input type="text" id="edit-paymentInfo" placeholder="å¸³è™Ÿæœ«5ç¢¼/è¡—å£å¸³è™Ÿç­‰">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>è¨‚å–®ç‹€æ…‹</label>
                        <select id="edit-status">
                            <option value="æœªè™•ç†">æœªè™•ç†</option>
                            <option value="å®Œæˆå¾…å–">å®Œæˆå¾…å–</option>
                            <option value="å·²å‡ºè²¨">å·²å‡ºè²¨</option>
                            <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å°å¸³ç‹€æ…‹</label>
                        <select id="edit-paymentVerified">
                            <option value="">æœªå°å¸³</option>
                            <option value="å·²å°å¸³">âœ… å·²å°å¸³</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="edit-note" placeholder="å…§éƒ¨å‚™è¨»..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof GAS_API_URL === 'undefined' || GAS_API_URL.includes("YOUR_GAS_WEB_APP_URL")) {
                alert("è«‹å…ˆè¨­å®š GAS URL (è«‹æª¢æŸ¥ script.js)");
                return;
            }
            fetchOrders();
        });

        async function fetchOrders() {
            try {
                const response = await fetch(`${GAS_API_URL}?type=orders`);
                const orders = await response.json();
                console.log("Orders Data:", orders);
                renderDashboard(orders);
            } catch (e) {
                console.error("Fetch/Render Error:", e);
                alert("ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™: " + e.message);
            }
        }

        function calculateAndRenderStats(orders) {
            // Find or Create Container
            let container = document.getElementById('productStatsContainer');
            if (!container) {
                const statsGrid = document.querySelector('.stats-grid');
                const section = document.createElement('div');
                section.id = 'productStatsContainer';
                section.className = 'data-table-wrapper';
                section.style.marginBottom = '30px';
                section.style.padding = '25px';
                section.style.background = '#fff';
                section.style.borderRadius = '10px';
                section.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';

                // Header with Title and Filter
                const headerDiv = document.createElement('div');
                headerDiv.style.display = 'flex';
                headerDiv.style.alignItems = 'center';
                headerDiv.style.marginBottom = '20px';
                headerDiv.style.borderBottom = '1px solid #eee';
                headerDiv.style.paddingBottom = '15px';

                const title = document.createElement('h3');
                title.innerText = 'ğŸ“Š å•†å“éŠ·å”®çµ±è¨ˆ';
                title.style.margin = '0';
                title.style.color = '#333';
                title.style.fontSize = '1.3rem';

                headerDiv.appendChild(title);

                // Filter Buttons Container
                const filterContainer = document.createElement('div');
                filterContainer.id = 'statsFilterContainer';
                filterContainer.style.display = 'flex';
                filterContainer.style.gap = '8px';
                filterContainer.style.flexWrap = 'wrap';
                filterContainer.style.marginLeft = 'auto';

                // Status Options (Updated)
                const statuses = ['æœªè™•ç†', 'å®Œæˆå¾…å–', 'å·²å‡ºè²¨', 'å·²å–æ¶ˆ'];

                statuses.forEach(status => {
                    const btn = document.createElement('button');
                    btn.innerText = status;
                    // Default active unless 'å·²å–æ¶ˆ'
                    const isCancelled = (status === 'å·²å–æ¶ˆ');
                    if (!isCancelled) btn.className = 'filter-pill active';
                    else btn.className = 'filter-pill';

                    // Styles
                    btn.style.padding = '6px 12px';
                    btn.style.borderRadius = '20px';
                    btn.style.border = '1px solid var(--primary-color)';
                    btn.style.cursor = 'pointer';
                    btn.style.fontSize = '0.85rem';
                    btn.style.transition = 'all 0.2s';

                    // Initial State Style
                    if (!isCancelled) {
                        btn.style.background = 'var(--primary-color)';
                        btn.style.color = '#fff';
                    } else {
                        btn.style.background = '#fff';
                        btn.style.color = '#666';
                        btn.style.borderColor = '#ccc';
                    }

                    btn.dataset.status = status;

                    btn.onclick = () => {
                        const isActive = btn.classList.contains('active');
                        if (isActive) {
                            btn.classList.remove('active');
                            // Inactive Style
                            btn.style.background = '#fff';
                            btn.style.color = '#666';
                            btn.style.borderColor = '#ccc';
                        } else {
                            btn.classList.add('active');
                            // Active Style
                            btn.style.background = 'var(--primary-color)';
                            btn.style.color = '#fff';
                            btn.style.borderColor = 'var(--primary-color)';
                        }
                        if (window.currentOrdersData) {
                            calculateAndRenderStats(window.currentOrdersData);
                        }
                    };
                    filterContainer.appendChild(btn);
                });

                headerDiv.appendChild(filterContainer);

                const content = document.createElement('div');
                content.id = 'productStatsContent';
                content.style.display = 'grid';
                content.style.gridTemplateColumns = 'repeat(auto-fill, minmax(220px, 1fr))';
                content.style.gap = '20px';

                section.appendChild(headerDiv);
                section.appendChild(content);
                statsGrid.parentNode.insertBefore(section, statsGrid.nextSibling);
                container = section;
            }

            // Calculation Logic
            const activeStatuses = [];

            // Check DOM for active pills
            const pills = document.querySelectorAll('#statsFilterContainer .filter-pill.active');
            if (pills.length > 0) {
                pills.forEach(p => activeStatuses.push(p.dataset.status));
            } else {
                // Fallback if UI not ready (should not happen as we just built it) 
                // OR if user unselected all (valid case)
                // If container exists but no pills active, activeStatuses is empty.

                // However, for first load logic where container might not be in DOM yet?
                if (!document.getElementById('statsFilterContainer')) {
                    // First load default: All except Cancelled
                    activeStatuses.push('æœªè™•ç†', 'å®Œæˆå¾…å–', 'å·²å‡ºè²¨');
                }
            }

            const productStats = {};
            let matchCount = 0;

            orders.forEach(o => {
                // Multi-select Filter Logic
                if (document.getElementById('statsFilterContainer')) {
                    if (activeStatuses.length === 0) return; // All unselected -> Show nothing
                    if (!activeStatuses.includes(o.Status)) return;
                } else {
                    // Fallback default logic
                    if (o.Status === 'å·²å–æ¶ˆ') return;
                }

                matchCount++;
                const itemsStr = o.Items || "";
                const itemParts = itemsStr.split(/,\s*/);
                itemParts.forEach(part => {
                    const match = part.match(/(.+)x(\d+)$/);
                    if (match) {
                        const name = match[1].trim();
                        const qty = parseInt(match[2]);
                        if (productStats[name]) {
                            productStats[name] += qty;
                        } else {
                            productStats[name] = qty;
                        }
                    }
                });
            });

            // Render Results
            const contentDiv = document.getElementById('productStatsContent');
            contentDiv.innerHTML = '';

            const sortedItems = Object.entries(productStats).sort((a, b) => b[1] - a[1]);

            if (matchCount === 0 || sortedItems.length === 0) {
                contentDiv.innerHTML = `
                    <div style="grid-column: 1/-1; text-align:center; padding:30px; color:#999; background:#f9f9f9; border-radius:8px;">
                        ç„¡ç¬¦åˆæ¢ä»¶çš„éŠ·å”®æ•¸æ“š
                    </div>`;
                return;
            }

            sortedItems.forEach(([name, qty]) => {
                const card = document.createElement('div');
                card.style.background = '#fff';
                card.style.padding = '15px';
                card.style.borderRadius = '8px';
                card.style.border = '1px solid #eee';
                card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.03)';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.position = 'relative';
                card.style.overflow = 'hidden';

                // Left accent bar
                const bar = document.createElement('div');
                bar.style.position = 'absolute';
                bar.style.left = '0';
                bar.style.top = '0';
                bar.style.bottom = '0';
                bar.style.width = '5px';
                bar.style.background = 'var(--primary-color)';
                card.appendChild(bar);

                card.innerHTML += `
                    <div style="font-size:0.95rem; color:#666; margin-bottom:8px; padding-left:10px; line-height:1.4;">${name}</div>
                    <div style="font-size:1.8rem; font-weight:800; color:#333; padding-left:10px;">${qty} <span style="font-size:0.9rem; font-weight:normal; color:#999;">ä»½</span></div>
                `;
                contentDiv.appendChild(card);
            });
        }

        function renderDashboard(orders) {
            // Save globally for filtering logic
            window.currentOrdersData = orders;

            // Stats
            try {
                // 1. Basic Counts
                document.getElementById('totalOrders').innerText = orders.length;

                // 2. Revenue Parsing
                const revenue = orders.reduce((sum, o) => {
                    if (o.Status === 'å·²å–æ¶ˆ') return sum;
                    let valStr = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                    return sum + (parseFloat(valStr) || 0);
                }, 0);
                document.getElementById('totalRevenue').innerText = `$${Math.round(revenue).toLocaleString()}`;

                // 3. Product Sales Statistics (Enhanced)
                calculateAndRenderStats(orders);

                const pending = orders.filter(o => o.Status === 'æœªè™•ç†').length;
                document.getElementById('pendingOrders').innerText = pending;

                // Table
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';

                // Sort new to old (Robust Date Parsing)
                orders.sort((a, b) => {
                    const dateA = new Date(a.Timestamp);
                    const dateB = new Date(b.Timestamp);
                    // If invalid date (e.g. Chinese format issue), treat as 0 or current
                    const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
                    const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime();
                    return timeB - timeA;
                });

                orders.forEach(o => {
                    const tr = document.createElement('tr');
                    tr.dataset.order = JSON.stringify(o); // Store full order data for editing

                    // Display Date Safely
                    let dateDisplay = o.Timestamp;
                    const dateObj = new Date(o.Timestamp);
                    if (!isNaN(dateObj.getTime())) {
                        dateDisplay = dateObj.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                    }

                    // Status Dropdown
                    const statusOptions = ['æœªè™•ç†', 'å®Œæˆå¾…å–', 'å·²å‡ºè²¨', 'å·²å–æ¶ˆ'];
                    let statusHtml = `<select class="status-select" id="status-${o.Order_ID}">`;
                    statusOptions.forEach(st => {
                        const selected = (o.Status === st) ? 'selected' : '';
                        statusHtml += `<option value="${st}" ${selected}>${st}</option>`;
                    });
                    statusHtml += `</select>`;

                    // Price Display Safely
                    let priceVal = String(o.Grand_Total || o.Total_Amount || "0").replace(/[$,]/g, "");
                    let priceNum = parseFloat(priceVal) || 0;

                    // Payment Info Display
                    const paymentMethod = o.Payment_Method || '-';
                    const paymentInfo = o.Payment_Info || '';

                    // Verified Status (stored in Note field with prefix or separate field)
                    const isVerified = (o.Payment_Verified === 'å·²å°å¸³') || (o.Note && o.Note.includes('[å·²å°å¸³]'));
                    const verifiedBadge = isVerified
                        ? '<span class="verified-badge yes">âœ… å·²å°å¸³</span>'
                        : '<span class="verified-badge no">å¾…å°å¸³</span>';

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${o.Order_ID}</div>
                            <div style="font-size:0.85rem; color:#666;">${dateDisplay}</div>
                        </td>
                        <td>
                            <div>${o.Name}</div>
                            <div style="font-size:0.85rem; color:#666;">${o.Phone}</div>
                        </td>
                        <td>${o.Group_Leader || '-'}</td>
                        <td>
                            ${o.Delivery_Method}<br>
                            <span style="font-size:0.8rem; color:#888;">${o.Store_Info || ''}</span>
                        </td>
                        <td class="items-cell">${o.Items}</td>
                        <td style="font-weight:bold; color:var(--primary-color);">$${priceNum.toLocaleString()}</td>
                        <td>
                            <div class="payment-method">${paymentMethod}</div>
                        </td>
                        <td class="payment-info">
                            <div>${paymentInfo || '-'}</div>
                            ${verifiedBadge}
                        </td>
                        <td>${statusHtml}</td>
                        <td>
                            <input type="text" class="note-input" id="note-${o.Order_ID}" value="${o.Note || ''}" placeholder="å‚™è¨»..." style="width:120px;">
                        </td>
                        <td>
                            <button class="action-btn btn-save" onclick="updateOrder('${o.Order_ID}')">å„²å­˜</button>
                            <button class="action-btn btn-edit" onclick="openEditModal('${o.Order_ID}')">ç·¨è¼¯</button>
                            <button class="action-btn btn-verify ${isVerified ? 'verified' : ''}" onclick="toggleVerify('${o.Order_ID}')">${isVerified ? 'âœ“' : 'å°å¸³'}</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("Render Error:", err);
                alert("æ¸²æŸ“è¨‚å–®åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: " + err.message);
            }
        }

        async function updateOrder(orderId) {
            const status = document.getElementById(`status-${orderId}`).value;
            const note = document.getElementById(`note-${orderId}`).value;

            const btn = document.querySelector(`button[onclick="updateOrder('${orderId}')"]`);
            // Store original content
            const originalHTML = btn.innerHTML;

            // Set loading state with spinner
            btn.innerHTML = '<span class="spinner-icon"></span>';
            btn.disabled = true;
            btn.style.opacity = '0.7';

            try {
                const payload = {
                    action: 'updateOrder',
                    orderId: orderId,
                    status: status,
                    note: note
                };

                await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                // Since no-cors returns opaque, we assume success if no network error
                alert('æ›´æ–°æˆåŠŸï¼');
            } catch (e) {
                console.error(e);
                alert('æ›´æ–°å¤±æ•—');
            } finally {
                // Restore original state
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // Open Edit Modal
        function openEditModal(orderId) {
            // Find the order row and get stored data
            const row = document.querySelector(`tr[data-order*="${orderId}"]`);
            if (!row) {
                alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™');
                return;
            }

            const order = JSON.parse(row.dataset.order);

            // Populate form fields
            document.getElementById('edit-orderId').value = order.Order_ID;
            document.getElementById('edit-name').value = order.Name || '';
            document.getElementById('edit-phone').value = (order.Phone || '').replace(/^'/, '');
            document.getElementById('edit-groupLeader').value = order.Group_Leader || '';
            document.getElementById('edit-items').value = order.Items || '';
            document.getElementById('edit-totalAmount').value = parseInt(String(order.Total_Amount || 0).replace(/[$,]/g, '')) || 0;
            document.getElementById('edit-shippingFee').value = parseInt(order.Shipping_Fee) || 0;
            document.getElementById('edit-grandTotal').value = parseInt(String(order.Grand_Total || 0).replace(/[$,]/g, '')) || 0;
            document.getElementById('edit-deliveryMethod').value = order.Delivery_Method || 'ç¾å ´è‡ªå–';
            document.getElementById('edit-storeInfo').value = order.Store_Info || '';
            document.getElementById('edit-paymentMethod').value = order.Payment_Method || 'ATMè½‰å¸³';
            document.getElementById('edit-paymentInfo').value = order.Payment_Info || '';
            document.getElementById('edit-status').value = order.Status || 'æœªè™•ç†';
            document.getElementById('edit-paymentVerified').value = order.Payment_Verified || '';
            document.getElementById('edit-note').value = order.Note || '';

            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveOrderEdit(e) {
            e.preventDefault();

            const orderId = document.getElementById('edit-orderId').value;

            const payload = {
                action: 'updateOrderFull',
                orderId: orderId,
                name: document.getElementById('edit-name').value,
                phone: document.getElementById('edit-phone').value,
                groupLeader: document.getElementById('edit-groupLeader').value,
                items: document.getElementById('edit-items').value,
                totalAmount: parseInt(document.getElementById('edit-totalAmount').value) || 0,
                shippingFee: parseInt(document.getElementById('edit-shippingFee').value) || 0,
                grandTotal: parseInt(document.getElementById('edit-grandTotal').value) || 0,
                deliveryMethod: document.getElementById('edit-deliveryMethod').value,
                storeInfo: document.getElementById('edit-storeInfo').value,
                paymentMethod: document.getElementById('edit-paymentMethod').value,
                paymentInfo: document.getElementById('edit-paymentInfo').value,
                status: document.getElementById('edit-status').value,
                paymentVerified: document.getElementById('edit-paymentVerified').value,
                note: document.getElementById('edit-note').value
            };

            try {
                await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                alert('è¨‚å–®æ›´æ–°æˆåŠŸï¼');
                closeEditModal();
                location.reload(); // Refresh to show changes
            } catch (e) {
                console.error(e);
                alert('æ›´æ–°å¤±æ•—');
            }
        }

        async function toggleVerify(orderId) {
            const noteInput = document.getElementById(`note-${orderId}`);
            let note = noteInput.value;

            // Toggle verified status in note
            if (note.includes('[å·²å°å¸³]')) {
                note = note.replace('[å·²å°å¸³]', '').trim();
            } else {
                note = '[å·²å°å¸³] ' + note;
            }
            noteInput.value = note;

            // Also update the Payment_Verified field
            const payload = {
                action: 'updateOrder',
                orderId: orderId,
                note: note,
                paymentVerified: note.includes('[å·²å°å¸³]') ? 'å·²å°å¸³' : ''
            };

            try {
                await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                // Reload to reflect changes
                location.reload();
            } catch (e) {
                console.error(e);
                alert('å°å¸³ç‹€æ…‹æ›´æ–°å¤±æ•—');
            }
        }
    </script>
</body>

</html>